# История изменений коннектора CoCon

## 2025-10-15 15:00 - FIX: Исправлена потеря agenda ID между командами

### Проблема
`currentAgendaId` терялся между вызовами `StartVotingWithTemplate` и `StopVoting`,
потому что каждая команда создает новый экземпляр `CoconClient`.

В логах было: `⚠️ No agenda ID stored, skipping results fetch`

### Решение
Использовать глобальную переменную `globalCurrentAgendaId` на уровне модуля.

### Изменения
- `coconClient.js`: Добавлена `globalCurrentAgendaId` (строка 8)
- `startVotingWithTemplate`: Сохраняет в `globalCurrentAgendaId` (строка 325)
- `stopVoting`: Читает из `globalCurrentAgendaId` (строка 389)

### Тестирование
1. `git pull` на локальном ПК
2. Перезапустить коннектор
3. Запустить голосование → дождаться окончания
4. В логах должно быть: `✅ Got X votes from CoCon:`

---

## 2025-10-15 14:30 - Синхронизация голосов из CoCon в базу данных сайта

### Цель
Когда пользователь голосует на пульте CoCon → результаты автоматически записываются в базу данных сайта

### Изменённые файлы

#### 1. `src/backend/coconClient.js`
**Что изменено:**
- Добавлено поле `this.currentAgendaId = null` в конструктор (строка 10)
- Добавлена функция `getIndividualVotingResults(agendaId)` (строки 417-433)
  - Вызывает API: `GET /Voting/GetIndividualVotingResults/?Id={agendaId}`
  - Возвращает массив голосов: `[{DelegateId, VotingOptionId, SeatNumber}, ...]`
- В функции `startVotingWithTemplate()` добавлено сохранение agenda ID (строки 322-324):
  ```javascript
  this.currentAgendaId = agendaItemNumber;
  console.log(`[CoconClient] Stored agenda ID: ${this.currentAgendaId}`);
  ```
- В функции `stopVoting()` добавлено автоматическое получение результатов (строки 386-403):
  ```javascript
  // AUTO-FETCH VOTING RESULTS AFTER STOP
  if (this.currentAgendaId) {
    const results = await this.getIndividualVotingResults(this.currentAgendaId);
    // Логирование результатов в красивом формате
  }
  ```

**Зачем:**
- Автоматически получать результаты голосования после окончания
- Видеть в логах кто как проголосовал

**Риски:** МИНИМАЛЬНЫЕ
- Только новая функциональность, старая не затронута
- Если API недоступен - просто логирует ошибку, не падает

#### 2. `src/backend/commandHandlers.js`
**Что изменено:**
- Добавлена тестовая команда `GetVotingResults` (строки 88-98)
- Добавлена в map команд (строка 194)

**Зачем:**
- Возможность вручную получить результаты голосования для тестирования

**Риски:** НЕТ
- Только новая команда, существующие не затронуты

### Созданные файлы

#### 1. `VOTING-SYNC-NOTES.md`
Подробная документация процесса синхронизации голосов

#### 2. `CHANGELOG.md` (этот файл)
История всех изменений

### Что НЕ СЛОМАЛОСЬ
✅ Запуск голосования - работает как раньше
✅ Остановка голосования - работает как раньше
✅ Создание шаблонов - работает как раньше
✅ Все существующие команды - работают как раньше

### Что ДОБАВИЛОСЬ
✅ Автоматическое получение результатов голосования после остановки
✅ Красивое логирование результатов в консоль коннектора
✅ Тестовая команда GetVotingResults для ручного тестирования

### Следующие шаги
1. Протестировать получение результатов (запустить голосование, проголосовать на пультах, посмотреть логи)
2. Добавить поле `coconAgendaId` в таблицу `AgendaItem` (миграция БД)
3. Создать обработчик на сервере для записи голосов в базу
4. End-to-end тест: голосование на пульте → база данных → отображение на сайте

### Проблемы которые нужно исправить
⚠️ Голосование не останавливается в CoCon после окончания таймера (пульты остаются активными)
- Причина: Clear voting failed (error code 1)
- Нужно исследовать правильную последовательность Stop → Clear

---

## Предыдущая работа (до changelog)

### 2025-10-14
- Исправление таймера голосования (+1 секунда bug)
- Автоматический старт/стоп голосования в CoCon
- Добавление шаблона с CanCorrect=true
- Установка таймера на 24 часа с отключенным отображением
